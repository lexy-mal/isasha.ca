<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dino Finish Line Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    body { margin:0; background:#333; touch-action:none; }
    canvas { display:block; margin:0 auto; background:white; }
  </style>
</head>
<body>
<canvas id="game" width="800" height="350"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// WORLD CONSTANTS
const GROUND_Y = 280;
const GRAVITY  = 2000;
const JUMP     = -950;

const SCROLL_SPEED   = 330;
const CACTUS_DELAY   = 0.8;   // slightly easier spacing
const BIRD_MIN_DELAY = 4;
const BIRD_MAX_DELAY = 7;

// Number of cactuses to survive before finish line appears
const FINISH_CACTUS_COUNT = 50;

// DINO
let dino = {
  x: 70,
  y: GROUND_Y - 70,
  w: 60,
  h: 70,
  vy: 0,
  onGround: true,
  legTimer: 0,
  legFrame: 0,
  colorMain: "#4a9c4a",
  colorDark: "#2e6a2e"
};

// GAME STATE
let cactuses = [];
let birds     = [];
let clouds    = [];
let elapsed   = 0;
let nextCactusTime = 0;
let nextBirdTime   = 0;

let gameOver = false;
let youWin   = false;

let lives    = 45;

let invincibleTime = 0;
let cactusSurvived = 0;
let finishLine = null; // will be an object later
let winColorTimer = 0;   // time counter for color cycling after win

// AUDIO
let audioCtx = null;
function initAudio() {
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    if (AC) audioCtx = new AC();
  }
}
function playBeep(freq, duration, volume) {
  initAudio();
  if (!audioCtx) return;
  const osc  = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.frequency.value = freq;
  gain.gain.value = volume;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}
function playJumpSound() { playBeep(650, 0.08, 0.15); }
function playHitSound()  { playBeep(200, 0.25, 0.2);  }
function playWinSound()  { playBeep(900, 0.4, 0.3);   }

// RANDOM DINO COLOR
function randomDinoColors() {
  const hue = Math.floor(Math.random() * 360);
  const main = `hsl(${hue}, 70%, 50%)`;
  const dark = `hsl(${hue}, 80%, 35%)`;
  return { main, dark };
}

// CLOUDS
function resetClouds() {
  clouds = [];
  for (let i = 0; i < 4; i++) {
    clouds.push({
      x: Math.random() * canvas.width,
      y: 40 + Math.random() * 80,
      w: 80 + Math.random() * 60,
      h: 30 + Math.random() * 10,
      speed: 40 + Math.random() * 30
    });
  }
}

// OBSTACLES
function spawnCactus() {
  const h = 40 + Math.random() * 60;
  const w = 20 + Math.random() * 20;
  cactuses.push({
    x: canvas.width,
    y: GROUND_Y - h,
    w, h
  });
}

function scheduleNextBird() {
  nextBirdTime = elapsed + (BIRD_MIN_DELAY + Math.random() * (BIRD_MAX_DELAY - BIRD_MIN_DELAY));
}

function spawnBird() {
  const h = 20 + Math.random() * 10;
  const w = 40;
  const y = (GROUND_Y - 150) + Math.random()*70;
  birds.push({
    x: canvas.width,
    y, w, h,
    flapTimer: 0,
    flapFrame: 0
  });
}

// FINISH LINE
function spawnFinishLine() {
  finishLine = {
    x: canvas.width,
    y: GROUND_Y - 150,
    w: 40,
    h: 150
  };
}

// RESET
function reset() {
  const colors = randomDinoColors();
  dino.colorMain = colors.main;
  dino.colorDark = colors.dark;

  dino.y = GROUND_Y - dino.h;
  dino.vy = 0;
  dino.onGround = true;
  dino.legTimer = 0;
  dino.legFrame = 0;

  cactuses = [];
  birds    = [];
  clouds   = [];
  finishLine = null;

  elapsed = 0;
  nextCactusTime = 0;
  scheduleNextBird();
  cactusSurvived = 0;

  gameOver = false;
  youWin   = false;

  lives = 45;
  invincibleTime = 0;

  resetClouds();
}

// INPUT
function jumpOrRestart() {
  if (gameOver || youWin) {
    reset();
    return;
  }
  if (dino.onGround) {
    // Change color every jump
    const colors = randomDinoColors();
    dino.colorMain = colors.main;
    dino.colorDark = colors.dark;

    dino.vy = JUMP;
    dino.onGround = false;
    playJumpSound();
  }
}

window.addEventListener("mousedown", jumpOrRestart);
window.addEventListener("touchstart", (e) => { e.preventDefault(); jumpOrRestart(); }, { passive:false });
window.addEventListener("keydown", (e) => {
  if (e.code === "Space" || e.code === "ArrowUp") {
    e.preventDefault();
    jumpOrRestart();
  }
});

// COLLISION
function collide(a, b) {
  return !(
    a.x + a.w < b.x ||
    a.x > b.x + b.w ||
    a.y + a.h < b.y ||
    a.y > b.y + b.h
  );
}

// DRAW FUNCTIONS
function drawCloud(c) {
  ctx.fillStyle = "#ddeeff";
  ctx.beginPath();
  ctx.ellipse(c.x, c.y, c.w/2, c.h/2, 0, 0, Math.PI*2);
  ctx.fill();
}

function drawHearts() {
  for (let i=0;i<lives;i++){
    const x = 20 + i*24;
    const y = 25;
    ctx.fillStyle = "#ff4b5c";
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.bezierCurveTo(x-5, y-5, x-12, y-5, x-12, y+2);
    ctx.bezierCurveTo(x-12, y+8, x-5, y+12, x, y+16);
    ctx.bezierCurveTo(x+5, y+12, x+12, y+8, x+12, y+2);
    ctx.bezierCurveTo(x+12, y-5, x+5, y-5, x, y);
    ctx.fill();
  }
}

function drawDino(dt) {
  const flashing = invincibleTime > 0 && Math.floor(invincibleTime*20)%2===0;

  if (dino.onGround) {
    dino.legTimer += dt;
    if (dino.legTimer > 0.1) {
      dino.legTimer = 0;
      dino.legFrame = 1 - dino.legFrame;
    }
  }

  ctx.save();
  ctx.translate(dino.x, dino.y);

  ctx.fillStyle = flashing ? "#ffffff" : dino.colorMain;
  ctx.fillRect(0, dino.h*0.3, dino.w*0.7, dino.h*0.7);
  ctx.fillRect(dino.w*0.5, 0, dino.w*0.55, dino.h*0.45);

  ctx.fillStyle="white";
  ctx.fillRect(dino.w*0.9, dino.h*0.1, 8, 8);
  ctx.fillStyle="black";
  ctx.fillRect(dino.w*0.92, dino.h*0.12, 4, 4);

  ctx.fillStyle = flashing ? "#bbbbbb" : dino.colorDark;
  if (dino.legFrame===0) {
    ctx.fillRect( dino.w*0.1, dino.h*0.95, dino.w*0.2, dino.h*0.25 );
  } else {
    ctx.fillRect( dino.w*0.45, dino.h*0.95, dino.w*0.2, dino.h*0.25 );
  }

  ctx.restore();
}

function drawCactus(c) {
  ctx.fillStyle = "#2e8b57";
  ctx.fillRect(c.x, c.y, c.w, c.h);
}

function drawBird(b) {
  ctx.save();
  ctx.translate(b.x,b.y);
  ctx.fillStyle="#555";
  ctx.fillRect(0,0,b.w,b.h);

  ctx.beginPath();
  if (b.flapFrame===0){
    ctx.moveTo(0,b.h/2);
    ctx.lineTo(-20,-10);
    ctx.lineTo(0,b.h/2);
  } else {
    ctx.moveTo(0,b.h/2);
    ctx.lineTo(-20,b.h+10);
    ctx.lineTo(0,b.h/2);
  }
  ctx.fill();
  ctx.restore();
}

function drawFinishLine() {
  if (!finishLine) return;
  ctx.fillStyle = "#000";
  ctx.fillRect(finishLine.x, finishLine.y, finishLine.w, finishLine.h);

  ctx.fillStyle = "red";
  ctx.fillRect(finishLine.x - 30, finishLine.y, finishLine.w+60, 20);

  ctx.fillStyle = "white";
  ctx.font = "16px Arial";
  ctx.fillText("FINISH", finishLine.x - 5, finishLine.y + 15);
}

// MAIN LOOP
let lastTime = 0;
reset();

function loop(timestamp) {
  const dt = (timestamp-lastTime)/1000 || 0;
  lastTime = timestamp;
  elapsed += dt;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Sky
  ctx.fillStyle="#f0f8ff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Clouds
  for (let c of clouds){
    c.x -= c.speed * dt;
    if (c.x + c.w < 0){
      c.x = canvas.width + Math.random()*100;
    }
    drawCloud(c);
  }

  // Ground
  ctx.fillStyle="#deb887";
  ctx.fillRect(0,GROUND_Y,canvas.width,canvas.height-GROUND_Y);

  // Dino physics
  if (!gameOver && !youWin){
    dino.vy += GRAVITY*dt;
    dino.y  += dino.vy*dt;
    if (dino.y >= GROUND_Y - dino.h){
      dino.y = GROUND_Y - dino.h;
      dino.vy = 0;
      dino.onGround = true;
    }

    if (invincibleTime>0){
      invincibleTime -= dt;
      if (invincibleTime < 0) invincibleTime = 0;
    }

    // Cactus spawning
    if (!finishLine && elapsed >= nextCactusTime){
      spawnCactus();
      nextCactusTime = elapsed + CACTUS_DELAY;
    }

    // Move cactuses
    for (let c of cactuses){
      c.x -= SCROLL_SPEED * dt;
    }

    // Count passed cactuses & spawn finish line
    for (let c of cactuses){
      if (!c.passed && c.x + c.w < dino.x){
        c.passed = true;
        cactusSurvived++;
        if (cactusSurvived >= FINISH_CACTUS_COUNT && !finishLine){
          spawnFinishLine();
        }
      }
    }

    // Remove off-screen
    cactuses = cactuses.filter(c => c.x + c.w > 0);

    // Birds
    if (!finishLine && elapsed >= nextBirdTime){
      spawnBird();
      scheduleNextBird();
    }
    for (let b of birds){
      b.x -= (SCROLL_SPEED+50)*dt;
      b.flapTimer += dt;
      if (b.flapTimer > 0.15){
        b.flapTimer = 0;
        b.flapFrame = 1 - b.flapFrame;
      }
    }
    birds = birds.filter(b => b.x + b.w > 0);

    // Finish line movement
    if (finishLine){
      finishLine.x -= SCROLL_SPEED * dt;

      // Dino reaches finish
      if (finishLine.x < dino.x + dino.w){
    	youWin = true;
	    playWinSound();
 	   winColorTimer = 0;  // reset timer for rainbow flash effect
	}
    }

    // Collisions
    const dinoRect = { x:dino.x, y:dino.y, w:dino.w, h:dino.h };

    function handleHit(){
      if (invincibleTime>0) return;
      lives--;
      invincibleTime = 1.0;
      playHitSound();
      if (lives <= 0){
        gameOver = true;
      }
    }

    // Hit cactus
    for (let c of cactuses){
      if (collide(dinoRect,c)){
        handleHit();
        break;
      }
    }

    // Hit bird
    for (let b of birds){
      if (collide(dinoRect,b)){
        handleHit();
        break;
      }
    }
  }

  // Draw things
  cactuses.forEach(drawCactus);
  birds.forEach(drawBird);
  drawDino(dt);
  drawHearts();
  drawFinishLine();

  // GAME OVER SCREEN
  if (gameOver){
    ctx.fillStyle="rgba(0,0,0,0.5)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="white";
    ctx.font="40px Arial";
    ctx.textAlign="center";
    ctx.fillText("GAME OVER", 400,150);
    ctx.font="20px Arial";
    ctx.fillText("Click / Tap / Space to restart",400,200);
  }

  // WIN SCREEN
  if (youWin){
	 // Change dino colors every second during win celebration
winColorTimer += dt;
if (winColorTimer >= 1) {
    winColorTimer = 0;
    const colors = randomDinoColors();
    dino.colorMain = colors.main;
    dino.colorDark = colors.dark;
} 
	  
	  
    ctx.fillStyle="rgba(0,0,0,0.5)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="yellow";
    ctx.font="50px Arial";
    ctx.textAlign="center";
    ctx.fillText("YOU WIN!",400,150);
    ctx.font="22px Arial";
    ctx.fillText("Amazing! Tap to play again!",400,210);
  }

  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);
</script>
</body>
</html>